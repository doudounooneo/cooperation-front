<navigation-bar title="家庭" back="{{false}}" color="black" background="#FFF"></navigation-bar>
<scroll-view class="jd-page" scroll-y enhanced show-scrollbar="{{false}}">
  <view class="page-content">
    <!-- 家庭选择器 -->
    <view class="family-selector" wx:if="{{hasFamilies}}">
      <text class="selector-label">当前家庭</text>
      <picker mode="selector" range="{{families}}" range-key="name" bindchange="switchFamily">
        <view class="selector-btn">
          <text class="selector-value">{{currentFamilyName || '选择家庭'}}</text>
          <text class="selector-arrow">›</text>
        </view>
      </picker>
    </view>

    <!-- 无家庭状态 -->
    <view wx:if="{{!hasFamilies}}" class="empty-section">
      <view class="empty-icon">🏠</view>
      <text class="empty-text">还没有加入家庭</text>
      <text class="empty-hint">创建或加入一个家庭开始使用</text>
      <view class="btn-group">
        <button class="btn btn-primary" bindtap="goCreateFamily">
          <text>✨ 创建我的家庭</text>
        </button>
        <button class="btn btn-outline" bindtap="goBindFamily">
          <text>🔗 绑定已有家庭</text>
        </button>
      </view>
    </view>

    <!-- 有家庭状态 -->
    <view wx:else class="main-content">
      <!-- 统计卡片 -->
      <view class="stats-row">
        <view class="stat-card">
          <text class="stat-value">{{stats.totalTasks}}</text>
          <text class="stat-label">全部任务</text>
        </view>
        <view class="stat-card highlight">
          <text class="stat-value">{{stats.pendingTasks}}</text>
          <text class="stat-label">待领取</text>
        </view>
        <view class="stat-card">
          <text class="stat-value">{{stats.myTasks}}</text>
          <text class="stat-label">我的任务</text>
        </view>
        <view class="stat-card gold">
          <text class="stat-value">{{stats.totalPoints}}</text>
          <text class="stat-label">已赚积分</text>
        </view>
      </view>

      <!-- 发布按钮 -->
      <button class="btn btn-primary publish-btn" bindtap="openPublishModal">
        <text>📋 发布家庭任务</text>
      </button>
      
      <!-- 筛选 Tab -->
      <view class="filter-tabs">
        <block wx:for="{{statusTabs}}" wx:key="key">
          <view 
            class="tab-item {{currentTab === item.key ? 'active' : ''}}" 
            data-key="{{item.key}}"
            bindtap="switchTab"
          >
            <text>{{item.label}}</text>
          </view>
        </block>
      </view>
      
      <!-- 任务列表 -->
      <view class="task-list">
        <block wx:for="{{filteredTasks}}" wx:key="id">
          <view class="task-card {{item.status}}">
            <view class="task-info">
              <view class="task-header">
                <view class="task-title">{{item.title}}</view>
                <view wx:if="{{item.publisherId === userId && item.status === 'unassigned'}}" 
                      class="delete-btn" 
                      bindtap="deleteTask" 
                      data-id="{{item.id}}">✕</view>
              </view>
              <view wx:if="{{item.description}}" class="task-desc">{{item.description}}</view>
              <view class="task-meta">
                <view class="points-tag">
                  <text class="points-icon">⭐</text>
                  <text class="points-value">{{item.points}}</text>
                  <text class="points-label">积分</text>
                </view>
                <view class="status-tag status-{{item.status}}">
                  <text wx:if="{{item.status=='unassigned'}}">待领取</text>
                  <text wx:elif="{{item.status=='claimed'}}">进行中</text>
                  <text wx:elif="{{item.status=='completed'}}">待验证</text>
                  <text wx:elif="{{item.status=='verified'}}">已完成</text>
                </view>
              </view>
              <view wx:if="{{item.assigneeName}}" class="task-assignee">
                <text class="assignee-label">执行人：</text>
                <text class="assignee-name">{{item.assigneeName}}</text>
              </view>
            </view>
            <view class="task-actions">
              <button wx:if="{{item.status=='unassigned'}}" class="action-btn claim" bindtap="claimTask" data-id="{{item.id}}">领取</button>
              <button wx:if="{{item.status=='claimed' && item.assigneeId === userId}}" class="action-btn complete" bindtap="completeTask" data-id="{{item.id}}">完成</button>
              <button wx:if="{{item.status=='completed' && (isParent || item.publisherId === userId)}}" class="action-btn verify" bindtap="verifyTask" data-id="{{item.id}}">验证</button>
              <view wx:if="{{item.status=='verified'}}" class="done-badge">✓ 已发放</view>
            </view>
          </view>
        </block>
      </view>
      
      <!-- 空任务状态 -->
      <view wx:if="{{filteredTasks.length === 0}}" class="empty-tasks">
        <text class="empty-icon">📝</text>
        <text class="empty-text">暂无任务</text>
        <text class="empty-hint">点击上方按钮发布第一个任务</text>
      </view>
    </view>
  </view>
</scroll-view>

<!-- 发布任务弹窗 -->
<view wx:if="{{showPublishModal}}" class="modal-mask" catchtap="closePublishModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">📋 发布任务</text>
      <text class="modal-close" catchtap="closePublishModal">✕</text>
    </view>
    <view class="modal-body">
      <view class="form-group">
        <text class="form-label">任务标题 <text class="required">*</text></text>
        <input class="form-input" placeholder="例如：打扫客厅" value="{{publishForm.title}}" data-field="title" bindinput="onFormInput" catchtap="stopPropagation" />
      </view>
      <view class="form-group">
        <text class="form-label">积分奖励 <text class="required">*</text></text>
        <view class="points-input-wrap">
          <input class="form-input points-input" type="number" placeholder="5" value="{{publishForm.points}}" data-field="points" bindinput="onFormInput" catchtap="stopPropagation" />
          <text class="points-suffix">积分</text>
        </view>
      </view>
      <view class="form-group">
        <text class="form-label">任务描述</text>
        <textarea class="form-textarea" placeholder="可选，添加详细说明" value="{{publishForm.description}}" data-field="description" bindinput="onFormInput" catchtap="stopPropagation" />
      </view>
      <view class="form-group">
        <text class="form-label">截止日期</text>
        <picker mode="date" start="{{today}}" value="{{publishForm.deadline}}" data-field="deadline" bindchange="onFormInput">
          <view class="form-input picker-value">
            <text>{{publishForm.deadline || '可选，默认无期限'}}</text>
            <text class="picker-arrow">📅</text>
          </view>
        </picker>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn btn-ghost" catchtap="closePublishModal">取消</button>
      <button class="btn btn-primary" catchtap="submitPublish">发布任务</button>
    </view>
  </view>
</view>
